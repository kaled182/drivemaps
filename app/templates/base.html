{% extends "base.html" %}

{% block content %}
<div class="container my-4">
    <h2 class="mb-3"><i class="fas fa-map-marked-alt me-2"></i> Visualização de Endereços</h2>
    <div class="map-container mb-4">
        <div id="map"></div>
    </div>
    <!-- Se quiser mostrar uma tabela/lista de endereços, coloque aqui -->
</div>
{% endblock %}

{% block styles %}
    <!-- Aplica o CSS do mapa, pode garantir aqui também -->
    <link rel="stylesheet" href="{{ url_for('static', filename='map.css') }}">
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
<script>
// ========== CONFIG MAPA ==========
const enderecosData = {{ lista|tojson|safe }};
let map, markers = [], markerCluster;

// Função principal chamada pelo callback do Google
function initMap() {
    const validCoords = enderecosData.filter(e => e.latitude && e.longitude);
    if (validCoords.length === 0) {
        document.getElementById('map').innerHTML = '<div class="alert alert-warning m-3">Nenhuma localização válida para exibir</div>';
        return;
    }
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: new google.maps.LatLng(
            parseFloat(validCoords[0].latitude),
            parseFloat(validCoords[0].longitude)
        ),
        gestureHandling: 'greedy',
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true
    });
    markerCluster = new markerClusterer.MarkerClusterer({ map, markers: [] });
    enderecosData.forEach((item, idx) => {
        if (item.latitude && item.longitude) createMarker(idx, item);
    });
    const bounds = new google.maps.LatLngBounds();
    validCoords.forEach(e => bounds.extend(new google.maps.LatLng(parseFloat(e.latitude), parseFloat(e.longitude))));
    map.fitBounds(bounds);
}

function createMarker(idx, data) {
    if (!data.latitude || !data.longitude) return null;
    const position = new google.maps.LatLng(parseFloat(data.latitude), parseFloat(data.longitude));
    const marker = new google.maps.Marker({
        position,
        map,
        title: `${data.order_number || (idx + 1)} - ${data.address}`,
        icon: createPinIcon(idx, data),
        draggable: false
    });
    const infoWindow = new google.maps.InfoWindow({
        content: `<div class="map-infowindow"><h6>${data.order_number || 'Sem ID'}</h6><p>${data.address}</p><p>CEP: ${data.cep || 'Não informado'}</p>${data.status_google === 'OK' ? '<p class="text-success">✓ Validado</p>' : `<p class="text-danger">${data.status_google || 'Não validado'}</p>`}</div>`
    });
    marker.addListener('click', () => infoWindow.open(map, marker));
    markers[idx] = marker;
    markerCluster.addMarker(marker);
    return marker;
}

function createPinIcon(idx, data) {
    const num = data.order_number ? String(data.order_number).substr(0, 3) : idx + 1;
    const color = data.cor || '#4285F4';
    return {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: color,
        fillOpacity: 1,
        strokeColor: '#fff',
        strokeWeight: 2,
        scale: 10,
        label: { text: num, color: '#fff', fontSize: '12px' }
    };
}

// Torna initMap global (ESSENCIAL para o callback funcionar)
window.initMap = initMap;

// Carregamento dinâmico do Google Maps (callback = initMap)
if (document.getElementById('map')) {
    const script = document.createElement('script');
    script.src = "https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&libraries=places&callback=initMap";
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
}
</script>
{% endblock %}
