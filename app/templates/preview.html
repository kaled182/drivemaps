{% extends "base.html" %}

{% block content %}
<!-- MAPA GOOGLE + BOT√ÉO FULLSCREEN -->
<div style="position:relative;">
    <div id="map" class="gmaps-principal"></div>
    <button type="button" class="btn btn-outline-primary btn-sm"
            style="position:absolute; right:12px; top:12px; z-index:10;"
            onclick="abrirMapaFullscreen()">üîé Mapa em tela cheia</button>
</div>

<!-- CARDS MOBILE / TABELA DESKTOP -->
<div id="enderecos-lista">
    <form id="form-csv" action="{{ url_for('main.generate') }}" method="post">
        <!-- CARDS MOBILE -->
        <div class="d-block d-md-none">
            {% for item in lista %}
            <div class="card mb-2 {% if item.cep_ok %}border-success{% else %}border-danger{% endif %}" style="font-size:1em;">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-primary me-2" style="width:28px;">{{ loop.index }}</span>
                        <strong style="flex:1">{{ item.address }}</strong>
                    </div>
                    <div class="mb-1"><small>CEP Inf.:</small> {{item.cep}} | <small>CEP Google:</small> {{item.postal_code_encontrado or '-' }}</div>
                    <div>
                        <span class="text-muted small">Status:</span>
                        {% if item.status_google == 'OK' %}
                            <span class="text-success">OK</span>
                            {% if not item.rua_bate %}
                                <span class="text-warning">‚ö†Ô∏è Rua diferente do Google!</span>
                            {% endif %}
                        {% else %}
                            <span class="text-danger">{{ item.status_google or 'N√ÉO ENCONTRADO' }}</span>
                        {% endif %}
                    </div>
                    <div class="mt-2">
                        <input type="hidden" name="numero_pacote_{{ loop.index0 }}" value="{{item['order_number']}}">
                        <input type="text" class="form-control form-control-sm mb-1" name="endereco_{{ loop.index0 }}" value="{{item['address']}}" placeholder="Endere√ßo">
                        <input type="text" class="form-control form-control-sm mb-1" name="cep_{{ loop.index0 }}" value="{{item['cep']}}" placeholder="CEP">
                        <button type="button" onclick="validarLinha({{ loop.index0 }})" class="btn btn-warning btn-sm w-100 mb-1">Validar</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <!-- TABELA DESKTOP -->
        <div class="table-responsive d-none d-md-block" style="max-height:56vh; overflow-y:auto;">
            <table class="table table-bordered align-middle table-sm" id="tabela-enderecos" style="font-size:1em;">
                <thead class="table-light">
                    <tr>
                        <th style="width:32px;">#</th>
                        <th style="min-width:140px;">Endere√ßo</th>
                        <th style="min-width:100px;">CEP Informado</th>
                        <th style="min-width:86px;">CEP Google</th>
                        <th style="min-width:80px;">Status</th>
                        <th style="width:80px;">A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in lista %}
                    <tr id="linha-{{ loop.index0 }}" class="{% if item.cep_ok %}table-success{% else %}table-danger{% endif %}">
                        <td class="text-center px-1">{{ loop.index }}</td>
                        <td class="px-1">
                            <input type="hidden" name="numero_pacote_{{ loop.index0 }}" value="{{item['order_number']}}">
                            <input type="text" class="form-control form-control-sm" name="endereco_{{ loop.index0 }}" value="{{item['address']}}" style="min-width:120px;">
                        </td>
                        <td class="px-1">
                            <input type="text" class="form-control form-control-sm" name="cep_{{ loop.index0 }}" value="{{item['cep']}}" style="min-width:80px;">
                        </td>
                        <td class="cep-encontrado text-center px-1">{{ item['postal_code_encontrado'] or '-' }}</td>
                        <td class="status-google px-1">
                            {% if item.status_google == 'OK' %}
                                <span class="text-success">OK</span>
                                {% if not item.rua_bate %}
                                    <br><span class="text-warning" style="font-size:.97em;">‚ö†Ô∏è Rua diferente do Google!</span>
                                {% endif %}
                            {% else %}
                                <span class="text-danger">{{ item.status_google or 'N√ÉO ENCONTRADO' }}</span>
                            {% endif %}
                        </td>
                        <td class="px-1 text-center">
                            <button type="button" onclick="validarLinha({{ loop.index0 }})" class="btn btn-warning btn-sm w-100 mb-1">Validar</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <input type="hidden" name="total" value="{{lista|length}}">
        <button id="btn-csv" type="submit" name="finalizar" value="1" class="btn btn-success w-100 mt-2">
            Gerar CSV para MyWay
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<style>
.gmaps-principal { width: 100%; height: 340px; border-radius: 9px; margin-bottom: 8px; }
@media (max-width: 700px) {
    .gmaps-principal { height: 50vw !important; min-height: 220px !important; }
}
</style>
<script>
function abrirMapaFullscreen() {
    let el = document.getElementById('map');
    if (el.requestFullscreen) el.requestFullscreen();
    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    else if (el.msRequestFullscreen) el.msRequestFullscreen();
}

// Fun√ß√£o para exibir os pins dos endere√ßos no mapa
function initMap() {
    var enderecos = [
        {% for item in lista %}
        {% if item.latitude and item.longitude %}
        {
            lat: {{ item.latitude }},
            lng: {{ item.longitude }},
            title: "{{ item.order_number }} - {{ item.address | replace('"', "'") }}",
            status: "{{ 'valid' if item.cep_ok else 'invalid' }}"
        },
        {% endif %}
        {% endfor %}
    ];
    var center = (enderecos.length > 0) ? {lat: enderecos[0].lat, lng: enderecos[0].lng} : {lat: 41.7, lng: -8.8};
    var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 11,
        center: center
    });
    enderecos.forEach(function(e) {
        var pinColor = (e.status === 'valid') ? "http://maps.google.com/mapfiles/ms/icons/green-dot.png" : "http://maps.google.com/mapfiles/ms/icons/red-dot.png";
        new google.maps.Marker({
            position: {lat: e.lat, lng: e.lng},
            map: map,
            title: e.title,
            icon: pinColor
        });
    });
}

// Fun√ß√£o para validar uma linha individualmente (AJAX)
function validarLinha(idx) {
    const row = document.getElementById('linha-' + idx);
    const endereco = row.querySelector('input[name="endereco_' + idx + '"]').value;
    const cep = row.querySelector('input[name="cep_' + idx + '"]').value;
    const numero_pacote = row.querySelector('input[name="numero_pacote_' + idx + '"]').value;
    const btn = row.querySelector('button');
    btn.disabled = true;
    btn.textContent = "Validando...";
    fetch("/api/validar-linha", {
        method: "POST",
        body: new URLSearchParams({
            endereco: endereco,
            cep: cep,
            numero_pacote: numero_pacote
        })
    })
    .then(resp => resp.json())
    .then(data => {
        row.querySelector('input[name="endereco_' + idx + '"]').value = data.address;
        row.querySelector('input[name="cep_' + idx + '"]').value = data.cep;
        row.querySelector('td.cep-encontrado').innerHTML = data.postal_code_encontrado || "-";
        let tdGoogle = row.querySelector('td.status-google');
        if (data.status_google === "OK") {
            tdGoogle.innerHTML = '<span class="text-success">OK</span>';
            if (!data.rua_bate) {
                tdGoogle.innerHTML += '<br><span class="text-warning">‚ö†Ô∏è Rua diferente do Google!</span>';
            }
            row.className = "table-success";
        } else {
            tdGoogle.innerHTML = '<span class="text-danger">' + (data.status_google || "N√ÉO ENCONTRADO") + '</span>';
            row.className = "table-danger";
        }
        btn.disabled = false;
        btn.textContent = "Validar";
    })
    .catch(() => {
        btn.disabled = false;
        btn.textContent = "Validar";
        alert("Erro ao validar endere√ßo! Tente novamente.");
    });
    return false;
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&callback=initMap" async defer></script>
{% endblock %}
