{% extends "base.html" %}

{% block content %}
<!-- MAPA + BOT√ÉO FULLSCREEN -->
<div style="position:relative;">
    <div id="map" style="width:100%; height:320px; border-radius:9px; margin-bottom:12px;"></div>
    <button type="button" class="btn btn-outline-primary btn-sm"
            style="position:absolute; right:12px; top:12px; z-index:10;"
            onclick="abrirMapaFullscreen()">üîé Mapa em tela cheia</button>
</div>

<!-- TABELA -->
<div class="table-responsive" style="max-height:56vh; overflow-y:auto;">
    <form id="form-csv" action="{{ url_for('main.generate') }}" method="post">
        <table class="table table-bordered align-middle table-sm" id="tabela-enderecos" style="font-size:1em;">
            <thead class="table-light">
                <tr>
                    <th style="width:32px;">#</th>
                    <th style="min-width:140px;">Endere√ßo</th>
                    <th style="min-width:100px;">CEP Informado</th>
                    <th style="min-width:86px;">CEP Google</th>
                    <th style="min-width:80px;">Status</th>
                    <th style="width:80px;">A√ß√£o</th>
                </tr>
            </thead>
            <tbody>
                {% for item in lista %}
                <tr id="linha-{{ loop.index0 }}" class="{% if item.cep_ok %}table-success{% else %}table-danger{% endif %}">
                    <td class="text-center px-1">{{ loop.index }}</td>
                    <td class="px-1">
                        <input type="hidden" name="numero_pacote_{{ loop.index0 }}" value="{{item['order_number']}}">
                        <input type="text" class="form-control form-control-sm" name="endereco_{{ loop.index0 }}" value="{{item['address']}}" style="min-width:120px;">
                    </td>
                    <td class="px-1">
                        <input type="text" class="form-control form-control-sm" name="cep_{{ loop.index0 }}" value="{{item['cep']}}" style="min-width:80px;">
                    </td>
                    <td class="cep-encontrado text-center px-1">{{ item['postal_code_encontrado'] or '-' }}</td>
                    <td class="status-google px-1">
                        {% if item.status_google == 'OK' %}
                            <span class="text-success">OK</span>
                            {% if not item.rua_bate %}
                                <br><span class="text-warning" style="font-size:.97em;">‚ö†Ô∏è Rua diferente do Google!</span>
                            {% endif %}
                        {% else %}
                            <span class="text-danger">{{ item.status_google or 'N√ÉO ENCONTRADO' }}</span>
                        {% endif %}
                    </td>
                    <td class="px-1 text-center">
                        <button type="button" onclick="validarLinha({{ loop.index0 }})" class="btn btn-warning btn-sm w-100 mb-1">Validar</button>
                        <span class="valido-ok d-none text-success">‚úîÔ∏è</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <input type="hidden" name="total" value="{{lista|length}}">
        <button id="btn-csv" type="submit" name="finalizar" value="1" class="btn btn-success w-100 mt-2">
            Gerar CSV para MyWay
        </button>
    </form>
</div>

<!-- MODAL MAPA FULLSCREEN -->
<div class="modal fade" id="modalMapa" tabindex="-1" aria-labelledby="modalMapaLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-body p-0">
        <div id="map-fullscreen" style="width:100vw; height:100vh;"></div>
      </div>
      <button type="button" class="btn btn-light position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" style="z-index:10;">Fechar</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let markers = [];
let mapObj = null;

// --- MAPA PRINCIPAL E PINS DRAGGABLE ---
window.initMap = function() {
    // ---- dados dos endere√ßos ---
    var enderecos = [
        {% for item in lista %}
        {% if item.latitude and item.longitude %}
        {
            lat: {{ item.latitude }},
            lng: {{ item.longitude }},
            idx: {{ loop.index0 }},
            title: "{{ item.order_number }}",
            address: "{{ item.address | replace('"', "'") }}"
        },
        {% endif %}
        {% endfor %}
    ];

    var center = (enderecos.length > 0) ? {lat: enderecos[0].lat, lng: enderecos[0].lng} : {lat: 41.7, lng: -8.8};
    mapObj = new google.maps.Map(document.getElementById('map'), {
        zoom: 11,
        center: center
    });
    markers = [];
    enderecos.forEach(function(e, idx) {
        let marker = new google.maps.Marker({
            position: {lat: e.lat, lng: e.lng},
            map: mapObj,
            draggable: true,
            title: e.title,
            icon: {
                url: e.idx % 2 === 0
                    ? "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
                    : "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
                labelOrigin: new google.maps.Point(18, 12)
            },
            label: {
                text: String(idx+1),
                color: "#fff",
                fontWeight: "bold"
            }
        });

        // Drag & drop do PIN: atualiza campo endere√ßo
        marker.addListener('dragend', function(event) {
            atualizaEnderecoPorPin(idx, event.latLng.lat(), event.latLng.lng());
        });
        markers.push(marker);
    });
};

// Fun√ß√£o chamada ao arrastar PIN para novo local
function atualizaEnderecoPorPin(idx, lat, lng) {
    // Faz request reversa para obter endere√ßo
    fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key={{ GOOGLE_API_KEY }}&region=pt`)
    .then(resp => resp.json())
    .then(data => {
        if (data.status === "OK") {
            let addr = data.results[0].formatted_address || "";
            document.querySelector('input[name="endereco_' + idx + '"]').value = addr;
        }
    });
}

// Bot√£o de mapa fullscreen (abre modal Bootstrap)
function abrirMapaFullscreen() {
    var modal = new bootstrap.Modal(document.getElementById('modalMapa'));
    modal.show();

    setTimeout(function() {
        var enderecos = [
            {% for item in lista %}
            {% if item.latitude and item.longitude %}
            {
                lat: {{ item.latitude }},
                lng: {{ item.longitude }},
                idx: {{ loop.index0 }},
                title: "{{ item.order_number }}",
                address: "{{ item.address | replace('"', "'") }}"
            },
            {% endif %}
            {% endfor %}
        ];
        var mapFullscreen = new google.maps.Map(document.getElementById('map-fullscreen'), {
            zoom: 11,
            center: (enderecos.length > 0) ? {lat: enderecos[0].lat, lng: enderecos[0].lng} : {lat: 41.7, lng: -8.8}
        });
        enderecos.forEach(function(e, idx) {
            let marker = new google.maps.Marker({
                position: {lat: e.lat, lng: e.lng},
                map: mapFullscreen,
                draggable: true,
                title: e.title,
                icon: {
                    url: e.idx % 2 === 0
                        ? "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
                        : "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
                    labelOrigin: new google.maps.Point(18, 12)
                },
                label: {
                    text: String(idx+1),
                    color: "#fff",
                    fontWeight: "bold"
                }
            });
            marker.addListener('dragend', function(event) {
                atualizaEnderecoPorPin(idx, event.latLng.lat(), event.latLng.lng());
            });
        });
    }, 300);
}

// Fun√ß√£o para validar uma linha individualmente (AJAX)
function validarLinha(idx) {
    const row = document.getElementById('linha-' + idx);
    const endereco = row.querySelector('input[name="endereco_' + idx + '"]').value;
    const cep = row.querySelector('input[name="cep_' + idx + '"]').value;
    const numero_pacote = row.querySelector('input[name="numero_pacote_' + idx + '"]').value;
    const btn = row.querySelector('button');
    btn.disabled = true;
    btn.textContent = "Validando...";
    fetch("/api/validar-linha", {
        method: "POST",
        body: new URLSearchParams({
            endereco: endereco,
            cep: cep,
            numero_pacote: numero_pacote
        })
    })
    .then(resp => resp.json())
    .then(data => {
        row.querySelector('input[name="endereco_' + idx + '"]').value = data.address;
        row.querySelector('input[name="cep_' + idx + '"]').value = data.cep;
        row.querySelector('td.cep-encontrado').innerHTML = data.postal_code_encontrado || "-";
        let tdGoogle = row.querySelector('td.status-google');
        if (data.status_google === "OK") {
            tdGoogle.innerHTML = '<span class="text-success">OK</span>';
            if (!data.rua_bate) {
                tdGoogle.innerHTML += '<br><span class="text-warning">‚ö†Ô∏è Rua diferente do Google!</span>';
            }
            row.className = "table-success";
        } else {
            tdGoogle.innerHTML = '<span class="text-danger">' + (data.status_google || "N√ÉO ENCONTRADO") + '</span>';
            row.className = "table-danger";
        }
        btn.disabled = false;
        btn.textContent = "Validar";
        // (Opcional: atualizar pin no mapa principal, se quiser)
    })
    .catch(() => {
        btn.disabled = false;
        btn.textContent = "Validar";
        alert("Erro ao validar endere√ßo! Tente novamente.");
    });
    return false;
}
</script>
<!-- Bootstrap Modal -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&callback=initMap" async defer></script>
{% endblock %}
