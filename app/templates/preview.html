{% extends "base.html" %}

{% block content %}
<div class="container my-4">
    <h2 class="mb-3">
        <i class="fas fa-map-marked-alt me-2"></i> Visualização de Endereços
    </h2>

    <div class="alert alert-info mb-3">
        <i class="fas fa-info-circle me-2"></i>
        Total de endereços: {{ lista|length }} |
        Origem: {{ origens|join(', ') }}
    </div>

    <div class="map-container mb-4">
        <div id="map"></div>
    </div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
<style>
    .map-container #map {
        min-height: 300px;
        height: 500px;
        width: 100%;
        border-radius: 20px;
        box-shadow: 0 2px 20px #0001;
        background: #e9ecef;
        position: relative;
    }
    .map-infowindow {
        font-size: 14px;
        min-width: 180px;
    }
    .map-empty-message {
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
        background: rgba(255,255,255,0.95);
        border-radius: 12px;
        padding: 24px 36px;
        text-align: center;
        font-size: 1.1rem;
        box-shadow: 0 2px 10px #0001;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
<script>
const enderecosData = {{ lista|tojson|safe }};
let map, markers = [], markerCluster;

function showEmptyMapMessage() {
    const mapDiv = document.getElementById('map');
    mapDiv.innerHTML = `<div class="map-empty-message">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Nenhuma localização válida para exibir no mapa.<br>
        Verifique se os endereços foram validados corretamente.
    </div>`;
}

function initMap() {
    // Filtra só endereços com latitude/longitude válida
    const validCoords = enderecosData.filter(e => e.latitude && e.longitude);

    if (validCoords.length === 0) {
        showEmptyMapMessage();
        return;
    }

    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: new google.maps.LatLng(
            parseFloat(validCoords[0].latitude),
            parseFloat(validCoords[0].longitude)
        ),
        gestureHandling: 'greedy',
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true
    });

    markerCluster = new markerClusterer.MarkerClusterer({ map, markers: [] });

    validCoords.forEach((item, idx) => {
        createMarker(idx, item);
    });

    // Ajusta o mapa para todos marcadores
    const bounds = new google.maps.LatLngBounds();
    validCoords.forEach(e =>
        bounds.extend(new google.maps.LatLng(parseFloat(e.latitude), parseFloat(e.longitude)))
    );
    map.fitBounds(bounds);
}

function createMarker(idx, data) {
    const position = new google.maps.LatLng(parseFloat(data.latitude), parseFloat(data.longitude));
    const marker = new google.maps.Marker({
        position,
        map,
        title: `${data.order_number || (idx + 1)} - ${data.address}`,
        icon: createPinIcon(idx, data),
        draggable: false
    });
    const infoWindow = new google.maps.InfoWindow({
        content: `
            <div class="map-infowindow">
                <h6>${data.order_number || 'Sem ID'}</h6>
                <p>${data.address}</p>
                <p>CEP: ${data.cep || 'Não informado'}</p>
                ${data.status_google === 'OK'
                    ? '<p class="text-success">✓ Validado</p>'
                    : `<p class="text-danger">${data.status_google || 'Não validado'}</p>`}
            </div>
        `
    });
    marker.addListener('click', () => infoWindow.open(map, marker));
    markers[idx] = marker;
    markerCluster.addMarker(marker);
    return marker;
}

function createPinIcon(idx, data) {
    const num = data.order_number ? String(data.order_number).substr(0, 3) : idx + 1;
    const color = data.cor || '#4285F4';
    return {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: color,
        fillOpacity: 1,
        strokeColor: '#fff',
        strokeWeight: 2,
        scale: 10,
        label: { text: num, color: '#fff', fontSize: '12px' }
    };
}

// Torna initMap global
window.initMap = initMap;

// Carrega Google Maps API se houver pelo menos um endereço
const googleApiKey = "{{ GOOGLE_API_KEY }}";
if (document.getElementById('map')) {
    const validAny = enderecosData.some(e => e.latitude && e.longitude);
    if (validAny && googleApiKey) {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${googleApiKey}&libraries=places&callback=initMap`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    } else {
        showEmptyMapMessage();
    }
}
</script>
{% endblock %}
