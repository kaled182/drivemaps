{% extends "base.html" %}

{% block content %}
<div class="container my-4">
    <h2 class="mb-3">
        <i class="fas fa-map-marked-alt me-2"></i> Visualização de Endereços
    </h2>

    <div class="alert alert-info mb-3">
        <i class="fas fa-info-circle me-2"></i>
        Total de endereços: {{ lista|length }} |
        Origem: {{ origens|join(', ') }}
    </div>

    <div class="map-container mb-4">
        <div id="map"></div>
        <div id="map-status" class="text-muted small mt-2"></div>
    </div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
<style>
    .map-container #map {
        min-height: 300px;
        height: 500px;
        width: 100%;
        border-radius: 20px;
        box-shadow: 0 2px 20px #0001;
        background: #e9ecef;
        position: relative;
    }
    .map-infowindow {
        font-size: 14px;
        min-width: 180px;
    }
    .map-empty-message {
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
        background: rgba(255,255,255,0.95);
        border-radius: 12px;
        padding: 24px 36px;
        text-align: center;
        font-size: 1.1rem;
        box-shadow: 0 2px 10px #0001;
    }
    #map-status {
        font-family: monospace;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
<script>
const enderecosData = {{ lista|tojson|safe }};
const googleApiKey = "{{ GOOGLE_API_KEY }}";
let map, markers = [], markerCluster;

function updateStatus(message) {
    document.getElementById('map-status').innerText = message;
    console.log("Mapa Status:", message);
}

function showEmptyMapMessage(reason) {
    const mapDiv = document.getElementById('map');
    mapDiv.innerHTML = `<div class="map-empty-message">
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${reason || 'Nenhuma localização válida para exibir no mapa.'}<br>
        Verifique se os endereços foram validados corretamente.
    </div>`;
    updateStatus(`Erro: ${reason || 'Sem coordenadas válidas'}`);
}

function initMap() {
    try {
        updateStatus("Inicializando mapa...");
        
        // Filtra e valida coordenadas
        const validCoords = enderecosData.filter(e => {
            const lat = parseFloat(e.latitude);
            const lng = parseFloat(e.longitude);
            return !isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180;
        });

        updateStatus(`Endereços válidos: ${validCoords.length}/${enderecosData.length}`);
        
        if (validCoords.length === 0) {
            showEmptyMapMessage("Nenhuma coordenada válida encontrada");
            return;
        }

        // Cria mapa centralizado no primeiro endereço
        const firstCoord = validCoords[0];
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: { 
                lat: parseFloat(firstCoord.latitude), 
                lng: parseFloat(firstCoord.longitude) 
            },
            gestureHandling: 'greedy',
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true
        });

        // Configura cluster de marcadores
        markerCluster = new markerClusterer.MarkerClusterer({ map, markers: [] });

        // Cria marcadores
        validCoords.forEach((item, idx) => {
            try {
                createMarker(idx, item);
            } catch (markerError) {
                console.error(`Erro ao criar marcador ${idx}:`, markerError);
            }
        });

        // Ajusta zoom para todos marcadores
        const bounds = new google.maps.LatLngBounds();
        validCoords.forEach(e => bounds.extend({
            lat: parseFloat(e.latitude),
            lng: parseFloat(e.longitude)
        }));
        map.fitBounds(bounds);
        
        updateStatus(`Mapa carregado com ${validCoords.length} marcadores`);

    } catch (error) {
        console.error("Erro ao inicializar mapa:", error);
        showEmptyMapMessage(`Erro técnico: ${error.message}`);
    }
}

function createMarker(idx, data) {
    const position = { 
        lat: parseFloat(data.latitude), 
        lng: parseFloat(data.longitude) 
    };
    
    const marker = new google.maps.Marker({
        position,
        map,
        title: `${data.order_number || (idx + 1)} - ${data.address}`,
        icon: createPinIcon(idx, data),
        draggable: false
    });
    
    const infoWindow = new google.maps.InfoWindow({
        content: `
            <div class="map-infowindow">
                <h6>${data.order_number || 'Sem ID'}</h6>
                <p>${data.address}</p>
                <p>CEP: ${data.cep || 'Não informado'}</p>
                ${data.status_google === 'OK'
                    ? '<p class="text-success">✓ Validado</p>'
                    : `<p class="text-danger">${data.status_google || 'Não validado'}</p>`}
            </div>
        `
    });
    
    marker.addListener('click', () => infoWindow.open(map, marker));
    markers[idx] = marker;
    markerCluster.addMarker(marker);
    
    return marker;
}

function createPinIcon(idx, data) {
    const num = data.order_number ? String(data.order_number).substr(-3) : idx + 1;
    const color = data.cor || '#4285F4';
    return {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: color,
        fillOpacity: 1,
        strokeColor: '#fff',
        strokeWeight: 2,
        scale: 10,
        label: { 
            text: String(num).substr(0, 3), 
            color: '#fff', 
            fontSize: '12px' 
        }
    };
}

// Torna initMap global
window.initMap = initMap;

// Inicialização
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('map')) {
        updateStatus("Verificando dados...");
        
        const hasValidData = enderecosData.some(e => 
            e.latitude && e.longitude &&
            !isNaN(parseFloat(e.latitude)) && 
            !isNaN(parseFloat(e.longitude))
        );

        if (hasValidData && googleApiKey) {
            updateStatus("Carregando API do Google Maps...");
            
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${googleApiKey}&libraries=places&callback=initMap`;
            script.async = true;
            script.defer = true;
            script.onerror = () => {
                showEmptyMapMessage("Falha ao carregar API do Google Maps");
            };
            document.head.appendChild(script);
        } else {
            const reason = !hasValidData ? "Sem dados válidos" : "Chave da API não configurada";
            showEmptyMapMessage(reason);
        }
    }
});
</script>
{% endblock %}
