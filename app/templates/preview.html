{% extends "base.html" %}

{% block content %}
<h2>Pré-visualização dos Endereços</h2>

<!-- MAPA GOOGLE -->
<div id="map" style="width:100%; height:400px; margin-bottom:28px;"></div>

<form id="form-csv" action="{{ url_for('main.generate') }}" method="post">
    <table class="table table-bordered" id="tabela-enderecos">
        <thead>
            <tr>
                <th>#</th>
                <th>Endereço</th>
                <th>CEP Informado</th>
                <th>CEP Google</th>
                <th>Freguesia</th>
                <th>Status Google</th>
                <th>Corrigir/Confirmar</th>
            </tr>
        </thead>
        <tbody>
            {% for item in lista %}
            <tr id="linha-{{ loop.index0 }}" class="{% if item.cep_ok %}table-success{% else %}table-danger{% endif %}">
                <td>{{ loop.index }}</td>
                <td>
                    <input type="hidden" name="numero_pacote_{{ loop.index0 }}" value="{{item['order_number']}}">
                    <input type="text" class="form-control" name="endereco_{{ loop.index0 }}" value="{{item['address']}}">
                </td>
                <td>
                    <input type="text" class="form-control" name="cep_{{ loop.index0 }}" value="{{item['cep']}}">
                </td>
                <td class="cep-encontrado">{{ item['postal_code_encontrado'] or '-' }}</td>
                <td class="freguesia-google">{{ item['freguesia'] or '-' }}</td>
                <td class="status-google">
                    {% if item.status_google == 'OK' %}
                        <span class="text-success">OK</span>
                        {% if not item.rua_bate %}
                            <br><span class="text-warning">⚠️ Rua diferente do Google!</span>
                        {% endif %}
                    {% else %}
                        <span class="text-danger">{{ item.status_google or 'NÃO ENCONTRADO' }}</span>
                    {% endif %}
                </td>
                <td>
                    <button type="button" onclick="validarLinha({{ loop.index0 }})" class="btn btn-warning btn-sm">Validar</button>
                    <span class="valido-ok d-none text-success">✔️</span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <input type="hidden" name="total" value="{{lista|length}}">
    <button id="btn-csv" type="submit" name="finalizar" value="1" class="btn btn-success">
        Gerar CSV para MyWay
    </button>
</form>
{% endblock %}

{% block scripts %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&callback=initMap" async defer></script>
<script>
var map;
var markers = [];

function svgPin(numero, cor) {
    numero = String(numero).padStart(2, '0');
    return 'data:image/svg+xml;utf-8,' + encodeURIComponent(`
      <svg width="48" height="64" viewBox="0 0 48 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Sombra -->
        <ellipse cx="24" cy="59" rx="12" ry="5" fill="#000" fill-opacity="0.13"/>
        <!-- Corpo -->
        <path d="M24 4
                 a20 20 0 0 1 20 20
                 c0 11-13 32-20 36
                 c-7-4-20-25-20-36
                 a20 20 0 0 1 20-20z"
              fill="${cor}" stroke="#444" stroke-width="1"/>
        <!-- Sombra inclinada -->
        <polygon points="24,4 44,24 24,44" fill="#000" fill-opacity="0.12"/>
        <!-- Número -->
        <text x="24" y="29" text-anchor="middle" font-size="18" font-family="Arial" font-weight="bold" fill="#fff" stroke="#222" stroke-width="0.8" dy=".3em">${numero}</text>
      </svg>
    `);
}

// Inicializa o mapa e os pins
window.initMap = function() {
    markers = [];
    var enderecos = [
        {% for item in lista %}
        {% if item.latitude and item.longitude %}
        {
            lat: {{ item.latitude }},
            lng: {{ item.longitude }},
            title: "{{ item.order_number }} - {{ item.address | replace('"', "'") }}",
            status: "{{ 'valid' if item.cep_ok else 'invalid' }}",
            numero_pacote: "{{ item.order_number }}"
        },
        {% endif %}
        {% endfor %}
    ];
    var center = (enderecos.length > 0) ? {lat: enderecos[0].lat, lng: enderecos[0].lng} : {lat: 41.7, lng: -8.8};
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 11,
        center: center
    });
    enderecos.forEach(function(e, idx) {
        var cor = (e.status === 'valid') ? "#3adb31" : "#e74c3c";
        var marker = new google.maps.Marker({
            position: {lat: e.lat, lng: e.lng},
            map: map,
            title: e.title,
            icon: {
                url: svgPin(e.numero_pacote, cor),
                scaledSize: new google.maps.Size(48, 64)
            }
        });
        markers.push(marker);
    });
}

// Atualiza apenas o pin do endereço corrigido/validado
function atualizarPin(idx, lat, lng, numero_pacote, status) {
    if (markers[idx]) {
        markers[idx].setMap(null); // Remove antigo
    }
    var cor = (status === 'valid') ? "#3adb31" : "#e74c3c";
    markers[idx] = new google.maps.Marker({
        position: {lat: lat, lng: lng},
        map: map,
        title: String(numero_pacote),
        icon: {
            url: svgPin(numero_pacote, cor),
            scaledSize: new google.maps.Size(48, 64)
        }
    });
}

// Função AJAX para validação individual
window.validarLinha = function(idx) {
    const row = document.getElementById('linha-' + idx);
    const endereco = row.querySelector('input[name="endereco_' + idx + '"]').value;
    const cep = row.querySelector('input[name="cep_' + idx + '"]').value;
    const numero_pacote = row.querySelector('input[name="numero_pacote_' + idx + '"]').value;
    const btn = row.querySelector('button');
    btn.disabled = true;
    btn.textContent = "Validando...";
    fetch("/api/validar-linha", {
        method: "POST",
        body: new URLSearchParams({
            endereco: endereco,
            cep: cep,
            numero_pacote: numero_pacote
        })
    })
    .then(resp => resp.json())
    .then(data => {
        row.querySelector('input[name="endereco_' + idx + '"]').value = data.address;
        row.querySelector('input[name="cep_' + idx + '"]').value = data.cep;
        row.querySelector('td.cep-encontrado').innerHTML = data.postal_code_encontrado || "-";
        row.querySelector('td.freguesia-google').innerHTML = data.freguesia_google || "-";
        let tdGoogle = row.querySelector('td.status-google');
        if (data.status_google === "OK") {
            tdGoogle.innerHTML = '<span class="text-success">OK</span>';
            if (!data.rua_bate) {
                tdGoogle.innerHTML += '<br><span class="text-warning">⚠️ Rua diferente do Google!</span>';
            }
            row.className = "table-success";
        } else {
            tdGoogle.innerHTML = '<span class="text-danger">' + (data.status_google || "NÃO ENCONTRADO") + '</span>';
            row.className = "table-danger";
        }
        // Atualizar pin no mapa se latitude e longitude estiverem presentes
        if (data.latitude && data.longitude) {
            atualizarPin(idx, data.latitude, data.longitude, data.order_number, data.cep_ok ? 'valid' : 'invalid');
        }
        btn.disabled = false;
        btn.textContent = "Validar";
    })
    .catch(() => {
        btn.disabled = false;
        btn.textContent = "Validar";
        alert("Erro ao validar endereço! Tente novamente.");
    });
    return false;
}
</script>
{% endblock %}
