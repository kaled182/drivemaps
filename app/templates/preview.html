{% extends "base.html" %}

{% block content %}
<div class="container my-4">
    <h2 class="mb-3">
        <i class="fas fa-map-marked-alt me-2"></i> Visualização de Endereços
    </h2>
    <div class="alert alert-info mb-3">
        <i class="fas fa-info-circle me-2"></i>
        Total de endereços: {{ lista|length }} |
        Origem: {{ origens|join(', ') }}
    </div>
    <div class="map-container mb-4">
        <div id="map"></div>
        <div id="map-status" class="text-muted small mt-2"></div>
    </div>
</div>
{% endblock %}

{% block styles %}
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
<style>
    .map-container #map {
        min-height: 300px;
        height: 500px;
        width: 100%;
        border-radius: 20px;
        box-shadow: 0 2px 20px #0001;
        background: #e9ecef;
        position: relative;
    }
    .map-infowindow {
        font-size: 14px;
        min-width: 180px;
    }
    .map-empty-message {
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
        background: rgba(255,255,255,0.95);
        border-radius: 12px;
        padding: 24px 36px;
        text-align: center;
        font-size: 1.1rem;
        box-shadow: 0 2px 10px #0001;
    }
    #map-status {
        font-family: monospace;
    }
</style>
{% endblock %}

{% block scripts %}
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<script>
const enderecosData = {{ lista|tojson|safe }};
const mapboxToken = "{{ MAPBOX_TOKEN|default('') }}";
let map, markers = [];

function updateStatus(message) {
    document.getElementById('map-status').innerText = message;
    console.log("Mapa Status:", message);
}

function showEmptyMapMessage(reason) {
    const mapDiv = document.getElementById('map');
    mapDiv.innerHTML = `<div class="map-empty-message">
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${reason || 'Nenhuma localização válida para exibir no mapa.'}<br>
        Verifique se os endereços foram validados corretamente.
    </div>`;
    updateStatus(`Erro: ${reason || 'Sem coordenadas válidas'}`);
}

function initMapbox() {
    try {
        updateStatus("Inicializando mapa (Mapbox)...");
        if (!mapboxToken) {
            showEmptyMapMessage("Mapbox Token não configurado.");
            return;
        }

        // Filtra coordenadas válidas
        const validCoords = enderecosData.filter(e => {
            const lat = parseFloat(e.latitude);
            const lng = parseFloat(e.longitude);
            return !isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180;
        });

        updateStatus(`Endereços válidos: ${validCoords.length}/${enderecosData.length}`);
        if (validCoords.length === 0) {
            showEmptyMapMessage("Nenhuma coordenada válida encontrada");
            return;
        }

        mapboxgl.accessToken = mapboxToken;
        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [parseFloat(validCoords[0].longitude), parseFloat(validCoords[0].latitude)],
            zoom: 12
        });

        // Adiciona marcadores
        validCoords.forEach((item, idx) => {
            const marker = new mapboxgl.Marker({ color: item.cor || '#4285F4' })
                .setLngLat([parseFloat(item.longitude), parseFloat(item.latitude)])
                .setPopup(
                    new mapboxgl.Popup({ offset: 25 })
                    .setHTML(`
                        <div class="map-infowindow">
                            <h6>${item.order_number || 'Sem ID'}</h6>
                            <p>${item.address}</p>
                            <p>CEP: ${item.cep || 'Não informado'}</p>
                            ${item.status_google === 'OK'
                                ? '<p class="text-success">✓ Validado</p>'
                                : `<p class="text-danger">${item.status_google || 'Não validado'}</p>`}
                        </div>
                    `)
                )
                .addTo(map);
            markers.push(marker);
        });

        // Ajusta o mapa para mostrar todos os marcadores
        if (validCoords.length > 1) {
            const bounds = new mapboxgl.LngLatBounds();
            validCoords.forEach(e => bounds.extend([parseFloat(e.longitude), parseFloat(e.latitude)]));
            map.fitBounds(bounds, { padding: 60, animate: true });
        }

        updateStatus(`Mapa carregado com ${validCoords.length} marcadores (Mapbox)`);

    } catch (error) {
        console.error("Erro ao inicializar Mapbox:", error);
        showEmptyMapMessage(`Erro técnico: ${error.message}`);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('map')) {
        updateStatus("Verificando dados...");
        const hasValidData = enderecosData.some(e =>
            e.latitude && e.longitude &&
            !isNaN(parseFloat(e.latitude)) &&
            !isNaN(parseFloat(e.longitude))
        );
        if (hasValidData && mapboxToken) {
            updateStatus("Carregando mapa Mapbox...");
            initMapbox();
        } else {
            const reason = !hasValidData ? "Sem dados válidos" : "Mapbox Token não configurado";
            showEmptyMapMessage(reason);
        }
    }
});
</script>
{% endblock %}
