{% extends "base.html" %}

{% block content %}
<!-- MAPA GOOGLE -->
<div style="position:relative;">
    <div id="map" class="gmaps-principal"></div>
</div>

<!-- CARDS MOBILE / TABELA DESKTOP -->
<div id="enderecos-lista">
    <form id="form-csv" action="{{ url_for('main.generate') }}" method="post">
        <!-- CARDS MOBILE -->
        <div class="d-block d-md-none">
            {% for item in lista %}
            <div class="card mb-2 {% if item.cep_ok %}border-success{% else %}border-danger{% endif %}" style="font-size:1em;">
                <div class="card-body py-2 px-3">
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-primary me-2" style="width:28px;">{{ item.order_number }}</span>
                        <strong style="flex:1">{{ item.address }}</strong>
                    </div>
                    <div class="mb-1"><small>CODP:</small> {{item.cep}} | <small>CODP Google:</small> {{item.postal_code_encontrado or '-' }}</div>
                    <div>
                        <span class="text-muted small">Status:</span>
                        {% if item.status_google == 'OK' %}
                            <span class="text-success">OK</span>
                            {% if not item.rua_bate %}
                                <span class="text-warning" title="Rua diferente do Google!">⚠️</span>
                            {% endif %}
                        {% else %}
                            <span class="text-danger">{{ item.status_google or 'NÃO ENCONTRADO' }}</span>
                        {% endif %}
                    </div>
                    <div class="mt-2">
                        <input type="hidden" name="numero_pacote_{{ loop.index0 }}" value="{{item['order_number']}}">
                        <input type="text" class="form-control form-control-sm mb-1" name="endereco_{{ loop.index0 }}" value="{{item['address']}}" placeholder="Endereço">
                        <input type="text" class="form-control form-control-sm mb-1" name="cep_{{ loop.index0 }}" value="{{item['cep']}}" placeholder="CODP">
                        <button type="button" onclick="validarLinha({{ loop.index0 }})" class="btn btn-warning btn-sm w-100 mb-1">Validar</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <!-- TABELA DESKTOP -->
        <div class="table-responsive d-none d-md-block" style="max-height:56vh; overflow-y:auto;">
            <table class="table table-bordered align-middle table-sm" id="tabela-enderecos" style="font-size:1em;">
                <thead class="table-light">
                    <tr>
                        <th style="width:32px;">ID</th>
                        <th style="min-width:140px;">Endereço</th>
                        <th style="min-width:100px;">CODP</th>
                        <th style="min-width:86px;">CODP Google</th>
                        <th style="min-width:80px;">Status</th>
                        <th style="width:80px;">Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in lista %}
                    <tr id="linha-{{ loop.index0 }}" class="{% if item.cep_ok %}table-success{% else %}table-danger{% endif %}">
                        <td class="text-center px-1">{{ item.order_number }}</td>
                        <td class="px-1">
                            <input type="hidden" name="numero_pacote_{{ loop.index0 }}" value="{{item['order_number']}}">
                            <input type="text" class="form-control form-control-sm" name="endereco_{{ loop.index0 }}" value="{{item['address']}}" style="min-width:120px;">
                        </td>
                        <td class="px-1">
                            <input type="text" class="form-control form-control-sm" name="cep_{{ loop.index0 }}" value="{{item['cep']}}" style="min-width:80px;">
                        </td>
                        <td class="cep-encontrado text-center px-1">{{ item['postal_code_encontrado'] or '-' }}</td>
                        <td class="status-google px-1">
                            {% if item.status_google == 'OK' %}
                                <span class="text-success">OK</span>
                                {% if not item.rua_bate %}
                                    <span class="text-warning" title="Rua diferente do Google!">⚠️</span>
                                {% endif %}
                            {% else %}
                                <span class="text-danger">{{ item.status_google or 'NÃO ENCONTRADO' }}</span>
                            {% endif %}
                        </td>
                        <td class="px-1 text-center">
                            <button type="button" onclick="validarLinha({{ loop.index0 }})" class="btn btn-warning btn-sm w-100 mb-1">Validar</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <input type="hidden" name="total" value="{{lista|length}}">
        <button id="btn-csv" type="submit" name="finalizar" value="1" class="btn btn-success w-100 mt-2">
            Gerar CSV para MyWay
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<style>
.gmaps-principal { width: 100%; height: 340px; border-radius: 9px; margin-bottom: 8px; }
@media (max-width: 700px) {
    .gmaps-principal { height: 50vw !important; min-height: 220px !important; }
}
</style>
<script>
// Retorna um SVG base64 numerado com cor customizada (verde/vermelho)
function pinSvgBase64(numero, cor) {
    var svg = `<svg xmlns="http://www.w3.org/2000/svg" width="44" height="60" viewBox="0 0 44 60">
      <ellipse cx="22" cy="22" rx="21" ry="22" fill="${cor}" stroke="#333" stroke-width="2"/>
      <polygon points="12,36 22,59 32,36" fill="${cor}" stroke="#333" stroke-width="2"/>
      <text x="50%" y="60%" font-size="20" font-family="Arial" font-weight="bold" fill="#fff" text-anchor="middle" dominant-baseline="middle">${numero}</text>
    </svg>`;
    return "data:image/svg+xml;base64," + btoa(svg);
}

let markers = [];
let map;

// Inicializa Google Maps e pins numerados
function initMap() {
    var enderecos = [
        {% for item in lista %}
        {% if item.latitude and item.longitude %}
        {
            lat: {{ item.latitude }},
            lng: {{ item.longitude }},
            id: "{{ item.order_number }}",
            idx: {{ loop.index0 }},
            status: "{{ 'valid' if item.cep_ok else 'invalid' }}"
        },
        {% endif %}
        {% endfor %}
    ];
    var center = (enderecos.length > 0) ? {lat: enderecos[0].lat, lng: enderecos[0].lng} : {lat: 41.7, lng: -8.8};
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 11,
        center: center
    });
    // Remove markers antigos se já existirem
    markers.forEach(function(m) { m.setMap(null); });
    markers = [];
    enderecos.forEach(function(e) {
        let cor = (e.status === 'valid') ? "#43a047" : "#e53935";
        let iconUrl = pinSvgBase64(e.id, cor);
        let marker = new google.maps.Marker({
            position: {lat: e.lat, lng: e.lng},
            map: map,
            icon: { url: iconUrl, scaledSize: new google.maps.Size(40, 58) },
            draggable: true,
            title: "ID: " + e.id
        });
        // Atualiza linha ao arrastar
        marker.addListener('dragend', function(evt) {
            atualizarPosicao(e.idx, evt.latLng.lat(), evt.latLng.lng());
            // Atualiza pin para verde ao mover
            marker.setIcon({ url: pinSvgBase64(e.id, "#43a047"), scaledSize: new google.maps.Size(40, 58) });
        });
        markers.push(marker);
    });
}

// Atualiza a latitude/longitude no backend (AJAX)
function atualizarPosicao(idx, lat, lng) {
    fetch("/api/atualizar-coordenada", {
        method: "POST",
        body: new URLSearchParams({ idx: idx, lat: lat, lng: lng })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.sucesso) {
            // Força a linha ficar "valida" (verde) ao mover pin
            let row = document.getElementById('linha-' + idx);
            if(row) row.className = "table-success";
        }
    });
}

// Validação AJAX
function validarLinha(idx) {
    const row = document.getElementById('linha-' + idx);
    const endereco = row.querySelector('input[name="endereco_' + idx + '"]').value;
    const cep = row.querySelector('input[name="cep_' + idx + '"]').value;
    const numero_pacote = row.querySelector('input[name="numero_pacote_' + idx + '"]').value;
    const btn = row.querySelector('button');
    btn.disabled = true;
    btn.textContent = "Validando...";
    fetch("/api/validar-linha", {
        method: "POST",
        body: new URLSearchParams({
            endereco: endereco,
            cep: cep,
            numero_pacote: numero_pacote
        })
    })
    .then(resp => resp.json())
    .then(data => {
        row.querySelector('input[name="endereco_' + idx + '"]').value = data.address;
        row.querySelector('input[name="cep_' + idx + '"]').value = data.cep;
        row.querySelector('td.cep-encontrado').innerHTML = data.postal_code_encontrado || "-";
        let tdGoogle = row.querySelector('td.status-google');
        if (data.status_google === "OK") {
            tdGoogle.innerHTML = '<span class="text-success">OK</span>';
            if (!data.rua_bate) {
                tdGoogle.innerHTML += '<span class="text-warning" title="Rua diferente do Google!">⚠️</span>';
            }
            row.className = "table-success";
            // Atualiza pin para verde ao validar
            if (window.markers && window.markers[idx]) {
                let id = numero_pacote;
                window.markers[idx].setIcon({ url: pinSvgBase64(id, "#43a047"), scaledSize: new google.maps.Size(40, 58) });
            }
        } else {
            tdGoogle.innerHTML = '<span class="text-danger">' + (data.status_google || "NÃO ENCONTRADO") + '</span>';
            row.className = "table-danger";
            if (window.markers && window.markers[idx]) {
                let id = numero_pacote;
                window.markers[idx].setIcon({ url: pinSvgBase64(id, "#e53935"), scaledSize: new google.maps.Size(40, 58) });
            }
        }
        btn.disabled = false;
        btn.textContent = "Validar";
    })
    .catch(() => {
        btn.disabled = false;
        btn.textContent = "Validar";
        alert("Erro ao validar endereço! Tente novamente.");
    });
    return false;
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&callback=initMap" async defer></script>
{% endblock %}
