{% extends "base.html" %}

{% block content %}
<style>
  #map-top-sticky { position: sticky; top: 0; z-index: 100; background: #f8fafd; box-shadow: 0 4px 18px #0001; border-radius: 0 0 14px 14px; }
  @media (max-width: 600px) { #map-top-sticky { height: 240px !important; max-height: 45vh; } .table-responsive { overflow-x: auto; } .mobile-hidden { display: none; } }
  @media (min-width: 601px) { #map-top-sticky { height: 420px !important; max-height: 55vh; } }
  .table-responsive { margin-top: 6px; }
  .filter-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px; }
  .progress-sm { height: 24px; }
  #feedback-msg { min-height: 26px; }
  .tooltip-inner { max-width: 300px; }
  .cursor-move { cursor: move; }
  .btn-actions { white-space: nowrap; }
</style>

<div id="map-top-sticky">
    <div id="map" style="width:100%;height:100%;min-height:220px;"></div>
</div>

<div class="d-flex flex-wrap justify-content-between gap-2 mb-3">
    <form id="form-upload" enctype="multipart/form-data" method="post" action="{{ url_for('main.import_planilha') }}" class="d-flex flex-row gap-2">
        <select name="empresa" class="form-select form-select-sm" style="width:auto;" required>
            <option value="">Empresa</option>
            <option value="delnext">Delnext</option>
            <option value="paack">Paack (Padrão)</option>
        </select>
        <input type="file" name="planilha" accept=".xls,.xlsx,.csv,.txt" required class="form-control form-control-sm">
        <button type="submit" class="btn btn-secondary btn-sm" id="btn-importar">
            <span class="spinner-border spinner-border-sm d-none" id="spinner-importar"></span>
            Importar
        </button>
    </form>
</div>

<div id="feedback-msg" class="mb-2 text-danger fw-bold"></div>

<div class="table-responsive">
<form id="form-csv" action="{{ url_for('main.generate') }}" method="post" autocomplete="off">
    <table class="table table-bordered align-middle" id="tabela-enderecos">
        <thead class="table-light">
            <tr>
                <th style="width:40px;">ID</th>
                <th>Endereço</th>
                <th style="width:110px;">CODP</th>
                <th style="width:110px;">CODP Google</th>
                <th class="mobile-hidden" style="width:110px;">Status</th>
                <th style="width:120px;">Ação</th>
            </tr>
        </thead>
        <tbody id="corpo-tabela">
            {% for item in lista %}
            <tr id="linha-{{ loop.index0 }}" class="{% if item.cep_ok %}table-success{% else %}table-danger{% endif %}" data-origem="{{ item.importacao_tipo }}">
                <td style="font-weight: bold; text-align:center;">{{ item.order_number or loop.index }}</td>
                <td>
                    <input type="text" class="form-control" name="endereco_{{ loop.index0 }}" value="{{ item.address }}" 
                           data-bs-toggle="tooltip" data-bs-placement="top" 
                           title="{{ item.endereco_formatado or '' }}">
                </td>
                <td>
                    <input type="text" class="form-control" name="cep_{{ loop.index0 }}" value="{{ item.cep }}">
                </td>
                <td class="cep-encontrado">{{ item.postal_code_encontrado or '-' }}</td>
                <td class="status-google text-center mobile-hidden">
                    {% if item.status_google == 'OK' %}
                        <span class="text-success">OK</span>
                        {% if not item.rua_bate %}
                            <span data-bs-toggle="tooltip" title="Diferença encontrada: {{ item.rua_google }}">⚠️</span>
                        {% endif %}
                    {% else %}
                        <span class="text-danger">{{ item.status_google or 'NÃO ENCONTRADO' }}</span>
                    {% endif %}
                </td>
                <td class="text-center btn-actions">
                    <button type="button" onclick="validarLinha({{ loop.index0 }})" class="btn btn-warning btn-sm w-100 mb-1">
                        Validar
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="d-flex justify-content-between my-2">
        <button id="btn-csv" type="submit" name="finalizar" value="1" class="btn btn-success">
            Gerar CSV para MyWay
        </button>
    </div>
    <input type="hidden" name="total" id="total-linhas" value="{{ lista|length }}">
</form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
<script>
  // Passa os endereços para o JS, para uso pelo mapa
  const locations = [
    {% for item in lista %}
      {% if item.lat and item.lng %}
        {
          id: {{ item.order_number or loop.index }},
          lat: {{ item.lat|float }},
          lng: {{ item.lng|float }},
          title: `{{ item.address|e }}`
        },
      {% endif %}
    {% endfor %}
  ];
</script>
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&callback=initMap"></script>
{% endblock %}
