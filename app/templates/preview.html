{% extends "base.html" %}

{% block content %}
<style>
  #map-top-sticky { position: sticky; top: 0; z-index: 100; background: #f8fafd; box-shadow: 0 4px 18px #0001; border-radius: 0 0 14px 14px; }
  @media (max-width: 600px) { #map-top-sticky { height: 240px !important; max-height: 45vh; } }
  @media (min-width: 601px) { #map-top-sticky { height: 420px !important; max-height: 55vh; } }
  .table-responsive { margin-top: 6px; }
</style>

<div id="map-top-sticky">
    <div id="map" style="width:100%;height:100%;min-height:220px;"></div>
</div>

<div class="table-responsive">
<form id="form-csv" action="{{ url_for('main.generate') }}" method="post" autocomplete="off">
    <table class="table table-bordered align-middle" id="tabela-enderecos">
        <thead class="table-light">
            <tr>
                <th style="width:40px;">ID</th>
                <th>Endereço</th>
                <th style="width:110px;">CODP</th>
                <th style="width:110px;">CODP Google</th>
                <th style="width:110px;">Status</th>
                <th style="width:120px;">Ação</th>
            </tr>
        </thead>
        <tbody id="corpo-tabela">
            {% for item in lista %}
            <tr id="linha-{{ loop.index0 }}" class="{% if item.cep_ok %}table-success{% else %}table-danger{% endif %}">
                <td style="font-weight: bold; text-align:center;">{{ item['order_number'] or loop.index }}</td>
                <td>
                    <input type="hidden" name="numero_pacote_{{ loop.index0 }}" value="{{item['order_number']}}">
                    <input type="text" class="form-control" name="endereco_{{ loop.index0 }}" value="{{item['address']}}">
                </td>
                <td>
                    <input type="text" class="form-control" name="cep_{{ loop.index0 }}" value="{{item['cep']}}">
                </td>
                <td class="cep-encontrado">{{ item['postal_code_encontrado'] or '-' }}</td>
                <td class="status-google text-center">
                    {% if item.status_google == 'OK' %}
                        <span class="text-success">OK</span>
                        {% if not item.rua_bate %}
                            <span title="Rua diferente do Google!">⚠️</span>
                        {% endif %}
                    {% else %}
                        <span class="text-danger">{{ item.status_google or 'NÃO ENCONTRADO' }}</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <button type="button" onclick="validarLinha({{ loop.index0 }})" class="btn btn-warning btn-sm w-100 mb-1">Validar</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Botão de adicionar endereço manual na parte inferior -->
    <div class="d-flex justify-content-end my-2">
        <button type="button" class="btn btn-primary" onclick="adicionarEnderecoManual()">
            + Adicionar endereço
        </button>
    </div>

    <input type="hidden" name="total" id="total-linhas" value="{{lista|length}}">
    <button id="btn-csv" type="submit" name="finalizar" value="1" class="btn btn-success w-100 mt-3">
        Gerar CSV para MyWay
    </button>
</form>
</div>
{% endblock %}

{% block scripts %}
<script>
// -- Função SVG PIN (metade do tamanho visual anterior) --
function makeSvgPin(numero, corHex) {
    let n = String(numero).substring(0, 3);
    let svg = `<svg width="44" height="54" viewBox="0 0 44 54" fill="none" xmlns="http://www.w3.org/2000/svg">
      <ellipse cx="22" cy="22" rx="21" ry="21" fill="${corHex}"/>
      <rect x="18" y="37" width="8" height="13" rx="4" fill="${corHex}"/>
      <text x="22" y="31" text-anchor="middle" font-size="20" fill="#fff" font-family="Arial" font-weight="bold" alignment-baseline="middle" dominant-baseline="middle">${n}</text>
    </svg>`;
    return "data:image/svg+xml;base64," + btoa(svg);
}

let map;
let markers = [];
let enderecosData = [
    {% for item in lista %}
    {
        idx: {{ loop.index0 }},
        lat: {{ item.latitude|default('null') }},
        lng: {{ item.longitude|default('null') }},
        numero_pacote: "{{ item['order_number'] or loop.index }}",
        address: `{{ item.address|default('')|replace('`','\'')|e }}`,
        status: "{{ 'valid' if item.cep_ok else 'invalid' }}",
        cep_ok: {{ 'true' if item.cep_ok else 'false' }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// --- NOVO: Adicionar endereço manual ---
function adicionarEnderecoManual() {
    // Descobre o próximo índice
    let tbody = document.getElementById('corpo-tabela');
    let total = tbody.children.length;
    let nextIdx = total;

    // Evita múltiplos inputs de adição
    if (document.getElementById('linha-nova')) return;

    let tr = document.createElement('tr');
    tr.id = 'linha-nova';
    tr.innerHTML = `
        <td style="font-weight:bold;text-align:center;">Novo</td>
        <td>
            <input type="hidden" name="numero_pacote_${nextIdx}" value="">
            <input type="text" class="form-control" id="novo-endereco" placeholder="Endereço completo">
        </td>
        <td>
            <input type="text" class="form-control" id="novo-cep" placeholder="CEP">
        </td>
        <td class="cep-encontrado">-</td>
        <td class="status-google text-center">-</td>
        <td class="text-center">
            <button type="button" class="btn btn-success btn-sm w-100 mb-1" onclick="salvarNovoEndereco()">Salvar</button>
            <button type="button" class="btn btn-link text-danger" onclick="removerNovaLinha()">Cancelar</button>
        </td>
    `;
    tbody.appendChild(tr);
    document.getElementById('novo-endereco').focus();
}

function removerNovaLinha() {
    let tr = document.getElementById('linha-nova');
    if (tr) tr.remove();
}

function salvarNovoEndereco() {
    let endereco = document.getElementById('novo-endereco').value.trim();
    let cep = document.getElementById('novo-cep').value.trim();
    if (!endereco || !cep) {
        alert("Preencha endereço e CEP.");
        return;
    }

    // Chama a mesma API de validação usada pelo botão Validar
    fetch("/api/validar-linha", {
        method: "POST",
        body: new URLSearchParams({
            endereco: endereco,
            cep: cep,
            numero_pacote: ''
        })
    })
    .then(resp => resp.json())
    .then(data => {
        // Atualiza o total
        let tbody = document.getElementById('corpo-tabela');
        let total = tbody.children.length - (document.getElementById('linha-nova') ? 1 : 0);
        let idx = total;
        let row = document.createElement('tr');
        row.id = 'linha-' + idx;
        row.className = data.cep_ok ? 'table-success' : 'table-danger';
        row.innerHTML = `
            <td style="font-weight:bold;text-align:center;">${data.order_number || idx+1}</td>
            <td>
                <input type="hidden" name="numero_pacote_${idx}" value="${data.order_number || ''}">
                <input type="text" class="form-control" name="endereco_${idx}" value="${data.address}">
            </td>
            <td>
                <input type="text" class="form-control" name="cep_${idx}" value="${data.cep}">
            </td>
            <td class="cep-encontrado">${data.postal_code_encontrado || '-'}</td>
            <td class="status-google text-center">
                ${data.status_google === "OK"
                    ? '<span class="text-success">OK</span>' + (data.rua_bate ? '' : '<span title="Rua diferente do Google!">⚠️</span>')
                    : '<span class="text-danger">' + (data.status_google || "NÃO ENCONTRADO") + '</span>'
                }
            </td>
            <td class="text-center">
                <button type="button" onclick="validarLinha(${idx})" class="btn btn-warning btn-sm w-100 mb-1">Validar</button>
            </td>
        `;
        tbody.appendChild(row);

        // Atualiza o total para envio do CSV
        document.getElementById('total-linhas').value = idx + 1;

        // Adiciona no array JS para mapa (sem coordenada por enquanto)
        enderecosData.push({
            idx: idx,
            lat: data.latitude || null,
            lng: data.longitude || null,
            numero_pacote: data.order_number || (idx+1),
            address: data.address,
            status: data.cep_ok ? 'valid' : 'invalid',
            cep_ok: data.cep_ok
        });

        // Se tiver coordenada, adiciona no mapa:
        if (data.latitude && data.longitude) {
            const position = {lat: parseFloat(data.latitude), lng: parseFloat(data.longitude)};
            const cor = data.cep_ok ? "#44B100" : "#D82B2B";
            const pinUrl = makeSvgPin(data.order_number || (idx+1), cor);
            let marker = new google.maps.Marker({
                position: position,
                map: map,
                title: `${data.order_number || (idx+1)} - ${data.address}`,
                icon: { url: pinUrl, scaledSize: new google.maps.Size(22, 27) },
                draggable: true
            });
            markers[idx] = marker;
        }

        removerNovaLinha();
    })
    .catch(() => alert("Erro ao validar endereço!"));
}

function initMap() {
    const coordenadasValidas = enderecosData.filter(e => e.lat && e.lng);
    if (coordenadasValidas.length === 0) {
        document.getElementById('map').innerHTML =
            '<div class="alert alert-warning">Nenhuma coordenada válida para exibir</div>';
        return;
    }

    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: {
            lat: parseFloat(coordenadasValidas[0].lat),
            lng: parseFloat(coordenadasValidas[0].lng)
        }
    });

    const bounds = new google.maps.LatLngBounds();

    coordenadasValidas.forEach(e => {
        const position = {
            lat: parseFloat(e.lat),
            lng: parseFloat(e.lng)
        };
        bounds.extend(position);

        const numero = e.numero_pacote || (e.idx + 1);
        const cor = e.cep_ok ? "#44B100" : "#D82B2B";
        const pinUrl = makeSvgPin(numero, cor);

        const marker = new google.maps.Marker({
            position: position,
            map: map,
            title: `${numero} - ${e.address}`,
            icon: {
                url: pinUrl,
                scaledSize: new google.maps.Size(22, 27)
            },
            draggable: true
        });

        // Evento de arrastar
        marker.addListener('dragend', function(event) {
            if (confirm("Deseja atualizar o endereço para esta nova localização?")) {
                fetch("/api/reverse-geocode", {
                    method: "POST",
                    body: new URLSearchParams({
                        idx: e.idx,
                        lat: event.latLng.lat(),
                        lng: event.latLng.lng()
                    })
                })
                .then(r => r.json())
                .then(data => {
                    if(data.sucesso) {
                        let row = document.getElementById('linha-' + e.idx);
                        row.querySelector('input[name="endereco_' + e.idx + '"]').value = data.address;
                        row.querySelector('input[name="cep_' + e.idx + '"]').value = data.cep;
                        if(row.querySelector('td.cep-encontrado')) {
                            row.querySelector('td.cep-encontrado').innerHTML = data.cep || "-";
                        }
                        fetch("/api/validar-linha", {
                            method: "POST",
                            body: new URLSearchParams({
                                endereco: data.address,
                                cep: data.cep,
                                numero_pacote: numero
                            })
                        })
                        .then(resp => resp.json())
                        .then(val => {
                            let tdGoogle = row.querySelector('td.status-google');
                            if (val.status_google === "OK") {
                                tdGoogle.innerHTML = '<span class="text-success">OK</span>' +
                                    (val.rua_bate ? '' : '<span title="Rua diferente do Google!">⚠️</span>');
                                row.className = "table-success";
                            } else {
                                tdGoogle.innerHTML = '<span class="text-danger">' + (val.status_google || "NÃO ENCONTRADO") + '</span>';
                                row.className = "table-danger";
                            }
                            let corNova = val.cep_ok ? "#44B100" : "#D82B2B";
                            marker.setIcon({
                                url: makeSvgPin(numero, corNova),
                                scaledSize: new google.maps.Size(22, 27)
                            });
                        });
                    } else {
                        alert("Endereço não encontrado!");
                        marker.setPosition({lat: e.lat, lng: e.lng});
                    }
                })
                .catch(() => {
                    alert("Erro ao validar novo local! Tente novamente.");
                    marker.setPosition({lat: e.lat, lng: e.lng});
                });
            } else {
                marker.setPosition({lat: e.lat, lng: e.lng});
            }
        });

        markers[e.idx] = marker;
    });

    map.fitBounds(bounds);
}

function loadGoogleMaps() {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
}
document.addEventListener('DOMContentLoaded', loadGoogleMaps);

function validarLinha(idx) {
    const row = document.getElementById('linha-' + idx);
    const endereco = row.querySelector('input[name="endereco_' + idx + '"]').value;
    const cep = row.querySelector('input[name="cep_' + idx + '"]').value;
    const numero_pacote = row.querySelector('input[name="numero_pacote_' + idx + '"]').value;
    const btn = row.querySelector('button');
    btn.disabled = true;
    btn.textContent = "Validando...";

    fetch("/api/validar-linha", {
        method: "POST",
        body: new URLSearchParams({
            endereco: endereco,
            cep: cep,
            numero_pacote: numero_pacote
        })
    })
    .then(resp => resp.json())
    .then(data => {
        row.querySelector('input[name="endereco_' + idx + '"]').value = data.address;
        row.querySelector('input[name="cep_' + idx + '"]').value = data.cep;
        row.querySelector('td.cep-encontrado').innerHTML = data.postal_code_encontrado || "-";

        let tdGoogle = row.querySelector('td.status-google');
        if (data.status_google === "OK") {
            tdGoogle.innerHTML = '<span class="text-success">OK</span>' +
                (data.rua_bate ? '' : '<span title="Rua diferente do Google!">⚠️</span>');
            row.className = "table-success";
        } else {
            tdGoogle.innerHTML = '<span class="text-danger">' + (data.status_google || "NÃO ENCONTRADO") + '</span>';
            row.className = "table-danger";
        }
        btn.disabled = false;
        btn.textContent = "Validar";

        if (data.latitude && data.longitude && markers[idx]) {
            let novaLat = parseFloat(data.latitude);
            let novaLng = parseFloat(data.longitude);
            markers[idx].setPosition({lat: novaLat, lng: novaLng});
            let cor = data.cep_ok ? "#44B100" : "#D82B2B";
            let numero = data.order_number || (idx + 1);
            markers[idx].setIcon({
                url: makeSvgPin(numero, cor),
                scaledSize: new google.maps.Size(22, 27)
            });
            map.panTo({lat: novaLat, lng: novaLng});
        }
    })
    .catch(() => {
        btn.disabled = false;
        btn.textContent = "Validar";
        alert("Erro ao validar endereço! Tente novamente.");
    });
}
</script>
{% endblock %}
