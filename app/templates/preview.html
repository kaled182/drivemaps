{% extends "base.html" %}

{% block content %}
<style>
  #map-top-sticky { position: sticky; top: 0; z-index: 100; background: #f8fafd; box-shadow: 0 4px 18px #0001; border-radius: 0 0 14px 14px; }
  @media (max-width: 600px) { #map-top-sticky { height: 240px !important; max-height: 45vh; } .table-responsive { overflow-x: auto; } .mobile-hidden { display: none; } }
  @media (min-width: 601px) { #map-top-sticky { height: 420px !important; max-height: 55vh; } }
  .table-responsive { margin-top: 6px; }
  .filter-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px; }
  .progress-sm { height: 24px; }
  #carregando-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:#fff8; z-index:9999; display:none; align-items:center; justify-content:center; }
</style>

<div id="carregando-overlay">
  <div class="spinner-border text-primary" role="status"></div>
  <span class="ms-2">Carregando...</span>
</div>

<div id="map-top-sticky">
    <div id="map" style="width:100%;height:100%;min-height:220px;"></div>
</div>

<div class="d-flex flex-wrap justify-content-between gap-2 mb-3">
    <div class="d-flex flex-row gap-2">
        <select id="filtro-origem" class="form-select form-select-sm" onchange="filtrarPorOrigem()">
            <option value="">Todas as origens</option>
            {% for origem in origens %}
                <option value="{{ origem }}">{{ origem|capitalize }}</option>
            {% endfor %}
        </select>
        <button type="button" class="btn btn-warning btn-sm" onclick="validarTudo()">Validar Tudo</button>
    </div>
    <form id="form-upload" enctype="multipart/form-data" method="post" action="{{ url_for('main.import_planilha') }}" class="d-flex flex-row gap-2">
        <select name="empresa" class="form-select form-select-sm" style="width:auto;" required>
            <option value="">Empresa</option>
            <option value="delnext">Delnext</option>
            <option value="paack">Paack (Padrão)</option>
        </select>
        <input type="file" name="planilha" accept=".xls,.xlsx,.csv" required class="form-control form-control-sm">
        <button type="submit" class="btn btn-secondary btn-sm">Importar</button>
    </form>
</div>

<div id="progresso-validacao" class="progress progress-sm mb-3" style="display: none;">
    <div id="progresso-barra" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
</div>

<div class="table-responsive">
<form id="form-csv" action="{{ url_for('main.generate') }}" method="post" autocomplete="off">
    <table class="table table-bordered align-middle" id="tabela-enderecos">
        <thead class="table-light">
            <tr>
                <th style="width:40px;">ID</th>
                <th>Endereço</th>
                <th style="width:110px;">CODP</th>
                <th style="width:110px;">CODP Google</th>
                <th class="mobile-hidden" style="width:110px;">Status</th>
                <th class="mobile-hidden" style="width:100px;">Origem</th>
                <th style="width:120px;">Ação</th>
            </tr>
        </thead>
        <tbody id="corpo-tabela"></tbody>
    </table>
    <div class="d-flex justify-content-between my-2">
        <button type="button" class="btn btn-primary" onclick="adicionarEnderecoManual()">+ Adicionar endereço</button>
        <button id="btn-csv" type="submit" name="finalizar" value="1" class="btn btn-success">Gerar CSV para MyWay</button>
    </div>
    <input type="hidden" name="total" id="total-linhas" value="0">
</form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
<script>
let enderecosData = {{ lista|tojson }};
let map, markers = [], markerCluster = null;

function mostrarCarregamento(on) {
    document.getElementById('carregando-overlay').style.display = on ? 'flex' : 'none';
}

function makeSvgPin(numero, corHex) {
    let n = String(numero).substring(0, 3);
    let svg = `<svg width="44" height="54" viewBox="0 0 44 54" fill="none" xmlns="http://www.w3.org/2000/svg">
      <ellipse cx="22" cy="22" rx="21" ry="21" fill="${corHex}"/>
      <rect x="18" y="37" width="8" height="13" rx="4" fill="${corHex}"/>
      <text x="22" y="31" text-anchor="middle" font-size="20" fill="#fff" font-family="Arial" font-weight="bold" alignment-baseline="middle" dominant-baseline="middle">${n}</text>
    </svg>`;
    return "data:image/svg+xml;base64," + btoa(svg);
}

function criarMarker(idx, data) {
    if (markers[idx]) {
        markers[idx].setMap(null);
        if (markerCluster) markerCluster.removeMarker(markers[idx]);
    }
    if (!data.latitude || !data.longitude || isNaN(data.latitude) || isNaN(data.longitude)) return null;
    const position = {lat: parseFloat(data.latitude), lng: parseFloat(data.longitude)};
    const pinUrl = makeSvgPin(data.numero_pacote || data.order_number || (idx+1), data.cor || "#0074D9");

    let marker = new google.maps.Marker({
        position: position,
        map: map,
        title: `${data.numero_pacote || data.order_number || (idx+1)} - ${data.address}`,
        icon: { url: pinUrl, scaledSize: new google.maps.Size(22, 27) },
        draggable: false,
        visible: !document.getElementById('filtro-origem').value ||
                 document.getElementById('filtro-origem').value === data.importacao_tipo
    });
    markers[idx] = marker;
    if (markerCluster) markerCluster.addMarker(marker);
    return marker;
}

function atualizarTabela() {
    let corpo = document.getElementById('corpo-tabela');
    corpo.innerHTML = '';
    enderecosData.forEach((item, idx) => {
        let cor = item.cor || "#0074D9";
        corpo.innerHTML += `
        <tr id="linha-${idx}" class="${item.cep_ok ? 'table-success' : 'table-danger'}" data-origem="${item.importacao_tipo}">
            <td style="font-weight: bold; text-align:center;">${item.order_number || idx+1}</td>
            <td>
                <input type="hidden" name="numero_pacote_${idx}" value="${item.order_number || ''}">
                <input type="hidden" name="importacao_tipo_${idx}" value="${item.importacao_tipo || ''}">
                <input type="hidden" name="cor_${idx}" value="${cor}">
                <input type="text" class="form-control" name="endereco_${idx}" value="${item.address || ''}">
            </td>
            <td><input type="text" class="form-control" name="cep_${idx}" value="${item.cep || ''}"></td>
            <td class="cep-encontrado">${item.postal_code_encontrado || '-'}</td>
            <td class="status-google text-center mobile-hidden">
                ${item.status_google === 'OK'
                    ? `<span class="text-success">OK</span>${!item.rua_bate ? ' <span title="Rua diferente do Google!">⚠️</span>' : ''}`
                    : `<span class="text-danger">${item.status_google || 'NÃO ENCONTRADO'}</span>`
                }
            </td>
            <td class="mobile-hidden">
                <span class="filter-badge" style="background-color:${cor}; color: white;">
                    ${item.importacao_tipo ? item.importacao_tipo.charAt(0).toUpperCase() + item.importacao_tipo.slice(1) : 'Manual'}
                </span>
            </td>
            <td class="text-center">
                <button type="button" onclick="validarLinha(${idx})" class="btn btn-warning btn-sm w-100 mb-1">Validar</button>
            </td>
        </tr>
        `;
    });
    document.getElementById('total-linhas').value = enderecosData.length;
}

function atualizarFiltroOrigens(origens) {
    const select = document.getElementById('filtro-origem');
    select.innerHTML = `<option value="">Todas as origens</option>` +
        origens.map(o => `<option value="${o}">${o.charAt(0).toUpperCase() + o.slice(1)}</option>`).join('');
}

function atualizarMapa() {
    if (!enderecosData.length) {
        document.getElementById('map').innerHTML =
            '<div class="alert alert-warning">Nenhuma coordenada válida para exibir</div>';
        return;
    }
    let coordenadasValidas = enderecosData.filter(e =>
        e.latitude && e.longitude && !isNaN(e.latitude) && !isNaN(e.longitude)
    );
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: coordenadasValidas.length
            ? {lat: parseFloat(coordenadasValidas[0].latitude), lng: parseFloat(coordenadasValidas[0].longitude)}
            : {lat: 41.55, lng: -8.42}
    });
    markerCluster = new markerClusterer.MarkerClusterer({ map, markers: [] });
    markers = [];
    coordenadasValidas.forEach((e, idx) => criarMarker(idx, e));
    const bounds = new google.maps.LatLngBounds();
    coordenadasValidas.forEach(e =>
        bounds.extend({lat: parseFloat(e.latitude), lng: parseFloat(e.longitude)}));
    if (!bounds.isEmpty()) map.fitBounds(bounds);
}

function filtrarPorOrigem() {
    const origem = document.getElementById('filtro-origem').value;
    document.querySelectorAll('#corpo-tabela tr').forEach(linha => {
        linha.style.display = (!origem || linha.dataset.origem === origem) ? '' : 'none';
    });
    markers.forEach((marker, idx) => {
        if (marker) {
            const deveMostrar = !origem || enderecosData[idx].importacao_tipo === origem;
            marker.setVisible(deveMostrar);
        }
    });
    if (markerCluster) markerCluster.repaint();
}

function atualizarTudoInterface(data) {
    enderecosData = data.lista;
    atualizarTabela();
    atualizarFiltroOrigens(data.origens);
    atualizarMapa();
}

document.addEventListener('DOMContentLoaded', function() {
    atualizarTabela();
    atualizarMapa();

    // Importação AJAX
    document.getElementById('form-upload').addEventListener('submit', function(e) {
        e.preventDefault();
        mostrarCarregamento(true);
        fetch(this.action, { method: 'POST', body: new FormData(this) })
            .then(resp => {
                if (!resp.ok) throw new Error("Erro na rede.");
                return resp.json();
            })
            .then(data => {
                if (!data.success) throw new Error(data.msg || "Erro ao importar planilha.");
                atualizarTudoInterface(data);
            })
            .catch(err => alert(err.message))
            .finally(() => mostrarCarregamento(false));
    });
});

function validarLinha(idx) {
    mostrarCarregamento(true);
    const tr = document.getElementById(`linha-${idx}`);
    const endereco = tr.querySelector(`input[name="endereco_${idx}"]`).value;
    const cep = tr.querySelector(`input[name="cep_${idx}"]`).value;
    const numero_pacote = tr.querySelector(`input[name="numero_pacote_${idx}"]`).value;
    const importacao_tipo = tr.querySelector(`input[name="importacao_tipo_${idx}"]`).value;

    fetch('/api/validar-linha', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            idx, endereco, cep, numero_pacote, importacao_tipo
        })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success && data.item) {
            enderecosData[idx] = data.item;
            atualizarTabela();
            atualizarMapa();
        } else {
            alert(data.msg || "Erro ao validar linha.");
        }
    })
    .finally(() => mostrarCarregamento(false));
}

function validarTudo() {
    for (let i = 0; i < enderecosData.length; i++) validarLinha(i);
}

function adicionarEnderecoManual() {
    // Implemente sua lógica para adicionar um endereço manualmente
    alert('Função adicionar manual a implementar!');
}

// Se quiser sincronizar via AJAX sem reload a cada X segundos:
// setInterval(() => {
//   fetch('/api/session-data')
//      .then(r => r.json()).then(data => atualizarTudoInterface(data));
// }, 20000);

</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&callback=atualizarMapa"></script>
{% endblock %}
