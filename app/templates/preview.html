{% extends "base.html" %}

{% block title %}Visualização no Mapa | MapsDrive{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid p-0" style="height: calc(100vh - 56px);">
    <div id="map" style="width: 100%; height: 100%;"></div>

    <div id="map-status" class="position-absolute bottom-0 start-0 m-3 p-2 bg-light rounded shadow-sm small">
        Carregando...
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
<script>
// Pega os dados injetados pelo Flask
const enderecosData = {{ lista|tojson|safe }};
const googleApiKey = "{{ GOOGLE_API_KEY }}";

function updateStatus(message) {
    document.getElementById('map-status').innerText = message;
}

function showEmptyMapMessage(reason) {
    const mapDiv = document.getElementById('map');
    mapDiv.innerHTML = `<div class="d-flex h-100 align-items-center justify-content-center">
        <div class="text-center p-4 bg-white rounded shadow">
            <h5 class="text-danger">Mapa não pôde ser carregado</h5>
            <p class="text-muted">${reason}</p>
            <a href="{{ url_for('preview.home') }}" class="btn btn-primary btn-sm">Voltar ao Início</a>
        </div>
    </div>`;
}

// Função global que será chamada pela API do Google quando ela carregar
window.initMap = function() {
    try {
        updateStatus("API do Google carregada. Inicializando mapa...");
        
        const validCoords = enderecosData.filter(e => e.latitude && e.longitude);

        if (validCoords.length === 0) {
            showEmptyMapMessage("Nenhum endereço importado continha coordenadas válidas. Tente um arquivo diferente ou verifique os endereços.");
            return;
        }

        const map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: { lat: parseFloat(validCoords[0].latitude), lng: parseFloat(validCoords[0].longitude) },
            gestureHandling: 'greedy'
        });

        const markers = validCoords.map(item => {
            return new google.maps.Marker({
                position: { lat: parseFloat(item.latitude), lng: parseFloat(item.longitude) },
                title: `${item.order_number} - ${item.address}`
            });
        });
        
        new markerClusterer.MarkerClusterer({ markers, map });

        const bounds = new google.maps.LatLngBounds();
        validCoords.forEach(e => bounds.extend({ lat: parseFloat(e.latitude), lng: parseFloat(e.longitude) }));
        map.fitBounds(bounds);
        
        updateStatus(`Mapa carregado com ${validCoords.length} de ${enderecosData.length} endereços.`);

    } catch (error) {
        console.error("Erro fatal ao inicializar o mapa:", error);
        showEmptyMapMessage(`Erro de script: ${error.message}`);
    }
}

// Gatilho inicial para carregar o mapa
document.addEventListener('DOMContentLoaded', () => {
    if (!googleApiKey) {
        showEmptyMapMessage("A chave da API do Google não está configurada no servidor.");
        return;
    }
    
    // Carrega o script do Google Maps dinamicamente
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${googleApiKey}&callback=initMap`;
    script.async = true;
    script.defer = true;
    script.onerror = () => showEmptyMapMessage("Falha ao carregar o script do Google Maps. Verifique a conexão e a chave da API.");
    document.head.appendChild(script);
});
</script>
{% endblock %}
