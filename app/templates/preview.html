{% extends "base.html" %}

{% block content %}
<div class="mb-3" style="position:relative;">
    <div id="map" style="width:100%;height:350px;position:sticky;top:0;z-index:2;border-radius:10px;margin-bottom:18px;"></div>
</div>

<div class="table-responsive">
<form id="form-csv" action="{{ url_for('main.generate') }}" method="post" autocomplete="off">
    <table class="table table-bordered align-middle" id="tabela-enderecos">
        <thead class="table-light">
            <tr>
                <th style="width:40px;">ID</th>
                <th>Endereço</th>
                <th style="width:110px;">CODP</th>
                <th style="width:110px;">CODP Google</th>
                <th style="width:110px;">Status</th>
                <th style="width:120px;">Ação</th>
            </tr>
        </thead>
        <tbody>
            {% for item in lista %}
            <tr id="linha-{{ loop.index0 }}" class="{% if item.cep_ok %}table-success{% else %}table-danger{% endif %}">
                <td style="font-weight: bold; text-align:center;">{{ item['order_number'] or '?' }}</td>
                <td>
                    <input type="hidden" name="numero_pacote_{{ loop.index0 }}" value="{{item['order_number'] or '?'}}">
                    <input type="text" class="form-control" name="endereco_{{ loop.index0 }}" value="{{item['address']}}">
                </td>
                <td>
                    <input type="text" class="form-control" name="cep_{{ loop.index0 }}" value="{{item['cep']}}">
                </td>
                <td class="cep-encontrado">{{ item['postal_code_encontrado'] or '-' }}</td>
                <td class="status-google text-center">
                    {% if item.status_google == 'OK' %}
                        <span class="text-success">OK</span>
                        {% if not item.rua_bate %}
                            <span title="Rua diferente do Google!">⚠️</span>
                        {% endif %}
                    {% else %}
                        <span class="text-danger">{{ item.status_google or 'NÃO ENCONTRADO' }}</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <button type="button" onclick="validarLinha({{ loop.index0 }})" class="btn btn-warning btn-sm w-100 mb-1">Validar</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <input type="hidden" name="total" value="{{lista|length}}">
    <button id="btn-csv" type="submit" name="finalizar" value="1" class="btn btn-success w-100 mt-3">
        Gerar CSV para MyWay
    </button>
</form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&callback=initMap" async defer></script>
<script>
let markers = [];
let enderecosData = [
    {% for item in lista %}
    {
        idx: {{ loop.index0 }},
        lat: {{ item.latitude or 'null' }},
        lng: {{ item.longitude or 'null' }},
        numero_pacote: "{{ item.order_number or '?' }}",
        address: `{{ item.address|replace('`','\'')|e }}`,
        status: "{{ 'valid' if item.cep_ok else 'invalid' }}"
    },
    {% endfor %}
];

let map;

function initMap() {
    // Foco inicial: primeiro endereço válido ou centro genérico
    let primeiro = enderecosData.find(e => typeof e.lat === "number" && typeof e.lng === "number");
    let center = primeiro ? {lat: primeiro.lat, lng: primeiro.lng} : {lat: 41.7, lng: -8.8};

    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 11,
        center: center
    });

    let pinBase = "https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=";
    let pinGreen = "|44B100|fff";
    let pinRed = "|D82B2B|fff";

    enderecosData.forEach(function(e, idx) {
        if (typeof e.lat !== "number" || typeof e.lng !== "number" || isNaN(e.lat) || isNaN(e.lng)) return;
        let cor = (e.status === 'valid') ? pinGreen : pinRed;
        let label = e.numero_pacote && e.numero_pacote !== "null" && e.numero_pacote !== "" ? e.numero_pacote : "?";
        let marker = new google.maps.Marker({
            position: {lat: e.lat, lng: e.lng},
            map: map,
            title: label + " - " + e.address,
            icon: pinBase + encodeURIComponent(label) + cor,
            draggable: true
        });

        marker.addListener('dragend', function(event) {
            if(confirm("Deseja atualizar o endereço para esta nova localização?")) {
                fetch("/api/reverse-geocode", {
                    method: "POST",
                    body: new URLSearchParams({
                        idx: e.idx,
                        lat: event.latLng.lat(),
                        lng: event.latLng.lng()
                    })
                })
                .then(r => r.json())
                .then(data => {
                    if(data.sucesso) {
                        let row = document.getElementById('linha-' + e.idx);
                        row.querySelector('input[name="endereco_' + e.idx + '"]').value = data.address;
                        row.querySelector('input[name="cep_' + e.idx + '"]').value = data.cep;
                        row.className = "table-success";
                        enderecosData[e.idx].lat = event.latLng.lat();
                        enderecosData[e.idx].lng = event.latLng.lng();
                        marker.setIcon(pinBase + encodeURIComponent(label) + pinGreen);
                    } else {
                        alert("Endereço não encontrado!");
                        marker.setPosition({lat: e.lat, lng: e.lng});
                    }
                })
                .catch(() => {
                    alert("Erro ao validar novo local! Tente novamente.");
                    marker.setPosition({lat: e.lat, lng: e.lng});
                });
            } else {
                marker.setPosition({lat: e.lat, lng: e.lng});
            }
        });

        markers.push(marker);
    });
}

function validarLinha(idx) {
    const row = document.getElementById('linha-' + idx);
    const endereco = row.querySelector('input[name="endereco_' + idx + '"]').value;
    const cep = row.querySelector('input[name="cep_' + idx + '"]').value;
    const numero_pacote = row.querySelector('input[name="numero_pacote_' + idx + '"]').value || "?";
    const btn = row.querySelector('button');
    btn.disabled = true;
    btn.textContent = "Validando...";

    fetch("/api/validar-linha", {
        method: "POST",
        body: new URLSearchParams({
            endereco: endereco,
            cep: cep,
            numero_pacote: numero_pacote
        })
    })
    .then(resp => resp.json())
    .then(data => {
        row.querySelector('input[name="endereco_' + idx + '"]').value = data.address;
        row.querySelector('input[name="cep_' + idx + '"]').value = data.cep;
        row.querySelector('td.cep-encontrado').innerHTML = data.postal_code_encontrado || "-";
        let tdGoogle = row.querySelector('td.status-google');
        if (data.status_google === "OK") {
            tdGoogle.innerHTML = '<span class="text-success">OK</span>' +
                (data.rua_bate ? '' : '<span title="Rua diferente do Google!">⚠️</span>');
            row.className = "table-success";
        } else {
            tdGoogle.innerHTML = '<span class="text-danger">' + (data.status_google || "NÃO ENCONTRADO") + '</span>';
            row.className = "table-danger";
        }
        btn.disabled = false;
        btn.textContent = "Validar";

        // Atualiza pin do mapa (se coordenadas vieram)
        if (data.latitude && data.longitude) {
            let novaLat = parseFloat(data.latitude);
            let novaLng = parseFloat(data.longitude);
            if (markers[idx]) {
                markers[idx].setPosition({lat: novaLat, lng: novaLng});
                let cor = (data.cep_ok ? "|44B100|fff" : "|D82B2B|fff");
                let pinUrl = "https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=" +
                            encodeURIComponent(data.order_number || "?") + cor;
                markers[idx].setIcon(pinUrl);
                map.panTo({lat: novaLat, lng: novaLng});
            }
            enderecosData[idx].lat = novaLat;
            enderecosData[idx].lng = novaLng;
        }
    })
    .catch(() => {
        btn.disabled = false;
        btn.textContent = "Validar";
        alert("Erro ao validar endereço! Tente novamente.");
    });
    return false;
}
</script>
{% endblock %}
