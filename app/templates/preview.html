{% extends "base.html" %}

{% block content %}
<style>
  #map-top-sticky { 
    position: sticky; 
    top: 0; 
    z-index: 100; 
    background: #f8fafd; 
    box-shadow: 0 4px 18px #0001; 
    border-radius: 0 0 14px 14px; 
  }
  @media (max-width: 600px) { 
    #map-top-sticky { height: 240px !important; max-height: 45vh; } 
    .table-responsive { overflow-x: auto; }
    .mobile-hidden { display: none; }
  }
  @media (min-width: 601px) { 
    #map-top-sticky { height: 420px !important; max-height: 55vh; } 
  }
  .table-responsive { margin-top: 6px; }
  .filter-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px; }
  .progress-sm { height: 24px; }
</style>

<div id="map-top-sticky">
    <div id="map" style="width:100%;height:100%;min-height:220px;"></div>
</div>

<!-- Filtros e Controles -->
<div class="d-flex flex-wrap justify-content-between gap-2 mb-3">
    <div class="d-flex flex-row gap-2">
        <select id="filtro-origem" class="form-select form-select-sm" onchange="filtrarPorOrigem()">
            <option value="">Todas as origens</option>
            {% for origem in origens %}
                <option value="{{ origem }}">{{ origem|capitalize }}</option>
            {% endfor %}
        </select>
        <button type="button" class="btn btn-warning btn-sm" onclick="validarTudo()">Validar Tudo</button>
    </div>
    <form id="form-upload" enctype="multipart/form-data" method="post" action="{{ url_for('main.import_planilha') }}" class="d-flex flex-row gap-2">
        <select name="empresa" class="form-select form-select-sm" style="width:auto;" required>
            <option value="">Empresa</option>
            <option value="delnext">Delnext</option>
            <option value="paack">Paack (Padrão)</option>
        </select>
        <input type="file" name="planilha" accept=".xls,.xlsx,.csv" required class="form-control form-control-sm">
        <button type="submit" class="btn btn-secondary btn-sm">Importar</button>
    </form>
</div>

<div id="progresso-validacao" class="progress progress-sm mb-3" style="display: none;">
    <div id="progresso-barra" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
</div>

<div class="table-responsive">
<form id="form-csv" action="{{ url_for('main.generate') }}" method="post" autocomplete="off">
    <table class="table table-bordered align-middle" id="tabela-enderecos">
        <thead class="table-light">
            <tr>
                <th style="width:40px;">ID</th>
                <th>Endereço</th>
                <th style="width:110px;">CODP</th>
                <th style="width:110px;">CODP Google</th>
                <th class="mobile-hidden" style="width:110px;">Status</th>
                <th class="mobile-hidden" style="width:100px;">Origem</th>
                <th style="width:120px;">Ação</th>
            </tr>
        </thead>
        <tbody id="corpo-tabela">
            {% for item in lista %}
            <tr id="linha-{{ loop.index0 }}" class="{% if item.cep_ok %}table-success{% else %}table-danger{% endif %}" data-origem="{{ item.importacao_tipo }}">
                <td style="font-weight: bold; text-align:center;">{{ item['order_number'] or loop.index }}</td>
                <td>
                    <input type="hidden" name="numero_pacote_{{ loop.index0 }}" value="{{item['order_number']}}">
                    <input type="hidden" name="importacao_id_{{ loop.index0 }}" value="{{item['importacao_id']}}">
                    <input type="hidden" name="importacao_tipo_{{ loop.index0 }}" value="{{item['importacao_tipo']}}">
                    <input type="hidden" name="cor_{{ loop.index0 }}" value="{{item['cor']}}">
                    <input type="text" class="form-control" name="endereco_{{ loop.index0 }}" value="{{item['address']}}">
                </td>
                <td>
                    <input type="text" class="form-control" name="cep_{{ loop.index0 }}" value="{{item['cep']}}">
                </td>
                <td class="cep-encontrado">{{ item['postal_code_encontrado'] or '-' }}</td>
                <td class="status-google text-center mobile-hidden">
                    {% if item.status_google == 'OK' %}
                        <span class="text-success">OK</span>
                        {% if not item.rua_bate %}
                            <span title="Rua diferente do Google!">⚠️</span>
                        {% endif %}
                    {% else %}
                        <span class="text-danger">{{ item.status_google or 'NÃO ENCONTRADO' }}</span>
                    {% endif %}
                </td>
                <td class="mobile-hidden">
                    <span class="filter-badge" style="background-color:{{ item.cor|default('#0074D9') }}; color: white;">
                        {{ item.importacao_tipo|capitalize }}
                    </span>
                </td>
                <td class="text-center">
                    <button type="button" onclick="validarLinha({{ loop.index0 }})" class="btn btn-warning btn-sm w-100 mb-1">Validar</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="d-flex justify-content-between my-2">
        <button type="button" class="btn btn-primary" onclick="adicionarEnderecoManual()">+ Adicionar endereço</button>
        <button id="btn-csv" type="submit" name="finalizar" value="1" class="btn btn-success">Gerar CSV para MyWay</button>
    </div>
    <input type="hidden" name="total" id="total-linhas" value="{{lista|length}}">
</form>
</div>
{% endblock %}

{% block scripts %}
<script>
// -- Função SVG PIN --
function makeSvgPin(numero, corHex) {
    let n = String(numero).substring(0, 3);
    let svg = `<svg width="44" height="54" viewBox="0 0 44 54" fill="none" xmlns="http://www.w3.org/2000/svg">
      <ellipse cx="22" cy="22" rx="21" ry="21" fill="${corHex}"/>
      <rect x="18" y="37" width="8" height="13" rx="4" fill="${corHex}"/>
      <text x="22" y="31" text-anchor="middle" font-size="20" fill="#fff" font-family="Arial" font-weight="bold" alignment-baseline="middle" dominant-baseline="middle">${n}</text>
    </svg>`;
    return "data:image/svg+xml;base64," + btoa(svg);
}

let map;
let markers = [];
let markerCluster;

// Monta lista de endereços
let enderecosData = [
    {% for item in lista %}
    {
        idx: {{ loop.index0 }},
        lat: {{ item.latitude if item.latitude else 'null' }},
        lng: {{ item.longitude if item.longitude else 'null' }},
        numero_pacote: "{{ item['order_number'] or loop.index }}",
        address: `{{ item.address|default('')|replace('`','\'')|e }}`,
        status: "{{ 'valid' if item.cep_ok else 'invalid' }}",
        cep_ok: {{ 'true' if item.cep_ok else 'false' }},
        importacao_tipo: "{{ item.importacao_tipo }}",
        cor: "{{ item.cor|default('#0074D9') }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];
console.log("enderecosData", enderecosData);

function criarMarker(idx, data) {
    // Valida tipo
    if (
        data.latitude === null || data.longitude === null ||
        data.latitude === undefined || data.longitude === undefined ||
        data.latitude === '' || data.longitude === '' ||
        isNaN(Number(data.latitude)) || isNaN(Number(data.longitude))
    ) {
        return null;
    }
    const position = {lat: parseFloat(data.latitude), lng: parseFloat(data.longitude)};
    const cor = data.cep_ok ? "#44B100" : "#D82B2B";
    const pinUrl = makeSvgPin(data.order_number || (idx+1), cor);
    let marker = new google.maps.Marker({
        position: position,
        map: map,
        title: `${data.order_number || (idx+1)} - ${data.address}`,
        icon: { url: pinUrl, scaledSize: new google.maps.Size(22, 27) },
        draggable: true,
        visible: !document.getElementById('filtro-origem').value || 
                 document.getElementById('filtro-origem').value === data.importacao_tipo
    });
    markers[idx] = marker;
    if (markerCluster) markerCluster.addMarker(marker);
    return marker;
}

function initMap() {
    // Só plota se tiver lat/lng válidos!
    const coordenadasValidas = enderecosData.filter(e =>
        e.lat !== null && e.lng !== null && e.lat !== '' && e.lng !== '' &&
        !isNaN(Number(e.lat)) && !isNaN(Number(e.lng))
    );
    if (coordenadasValidas.length === 0) {
        document.getElementById('map').innerHTML =
            '<div class="alert alert-warning">Nenhuma coordenada válida para exibir</div>';
        return;
    }
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: {
            lat: parseFloat(coordenadasValidas[0].lat),
            lng: parseFloat(coordenadasValidas[0].lng)
        }
    });
    markerCluster = new markerClusterer.MarkerClusterer({ map, markers: [] });
    coordenadasValidas.forEach(e => {
        criarMarker(e.idx, {
            latitude: e.lat,
            longitude: e.lng,
            cep_ok: e.cep_ok,
            address: e.address,
            order_number: e.numero_pacote,
            importacao_tipo: e.importacao_tipo,
            cor: e.cor
        });
    });
    // Ajusta bounds
    const bounds = new google.maps.LatLngBounds();
    coordenadasValidas.forEach(e => {
        bounds.extend({lat: parseFloat(e.lat), lng: parseFloat(e.lng)});
    });
    if (!bounds.isEmpty()) map.fitBounds(bounds);
}

function loadGoogleMaps() {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
    // Clusterização
    const clusterScript = document.createElement('script');
    clusterScript.src = "https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js";
    document.head.appendChild(clusterScript);
}

document.addEventListener('DOMContentLoaded', loadGoogleMaps);
</script>
{% endblock %}
